<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/index.css">
    <link rel="icon" type="image/x-icon" href="https://play-lh.googleusercontent.com/_TNbiYKasPy_isTSEg2_UEzVaev4F8fO2lLunsHJ8_Ux2g3OzkSZyzpqvJG1woSj-WD4=w240-h480-rw">
    <title>mObywatel</title>
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.11.0/dist/umd/supabase.min.js"></script>
</head>
<body>
    <script>
    const SUPABASE_URL = 'https://dvvugjmnjjhhafqcdpmt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // obetnij do test√≥w

    function logToScreen(message) {
        const logEl = document.getElementById('log');
        if (logEl) logEl.innerText += message + "\n";
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            logToScreen("Brak zalogowania - przekierowanie");
            window.location.href = 'login.html';
            return;
        }

        const goButton = document.querySelector('.go');
        if (goButton) {
            goButton.addEventListener('click', async (event) => {
                event.preventDefault();

                const name = document.getElementById('name').value;
                const surname = document.getElementById('surname').value;
                const sex = document.querySelector('.selected_text').innerText;
                const birthDay = document.querySelectorAll('.date_input')[0].value;
                const birthMonth = document.querySelectorAll('.date_input')[1].value;
                const birthYear = document.querySelectorAll('.date_input')[2].value;
                const nationality = document.getElementById('nationality').value;
                const familyName = document.getElementById('familyName').value;
                const fathersFamilyName = document.getElementById('fathersFamilyName').value;
                const mothersFamilyName = document.getElementById('mothersFamilyName').value;
                const birthPlace = document.getElementById('birthPlace').value;
                const countryOfBirth = document.getElementById('countryOfBirth').value;
                const adress1 = document.getElementById('adress1').value;
                const adress2 = document.getElementById('adress2').value;
                const city = document.getElementById('city').value;

                if (!name || !surname || !nationality || !familyName || !fathersFamilyName || !mothersFamilyName || !birthPlace || !countryOfBirth || !adress1 || !adress2 || !city || !birthDay || !birthMonth || !birthYear) {
                    logToScreen("‚ö†Ô∏è Wszystkie pola sƒÖ wymagane!");
                    return;
                }

                const dateStr = `${birthYear}-${birthMonth.padStart(2, '0')}-${birthDay.padStart(2, '0')}`;
                const birthDate = new Date(dateStr);
                if (isNaN(birthDate.getTime())) {
                    logToScreen("‚ö†Ô∏è Wprowad≈∫ poprawnƒÖ datƒô!");
                    return;
                }

                const data = {
                    name, surname, gender: sex,
                    dob_day: birthDay,
                    dob_month: birthMonth,
                    dob_year: birthYear,
                    nationality, family_name: familyName,
                    fathers_family_name: fathersFamilyName,
                    mothers_family_name: mothersFamilyName,
                    birth_place: birthPlace,
                    country_of_birth: countryOfBirth,
                    adress1, adress2, city
                };

                const photoElement = document.querySelector('.upload_uploaded');
                const photoUrl = photoElement ? photoElement.src : '';
                if (!photoUrl) {
                    logToScreen("‚ö†Ô∏è Proszƒô dodaƒá zdjƒôcie!");
                    return;
                }
                data.photo_url = photoUrl;

                logToScreen("‚è≥ Wysy≈Çam dane do Supabase...");
                logToScreen(JSON.stringify(data, null, 2));

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/entries`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify([data])
                    });

                    // Logowanie pe≈Çnej odpowiedzi
                    logToScreen(`üì° Odpowied≈∫ status: ${response.status}`);
                    const responseText = await response.text();
                    logToScreen("Odpowied≈∫ serwera (tekst):");
                    logToScreen(responseText);

                    // Pr√≥ba parsowania odpowiedzi jako JSON
                    try {
                        const responseJson = JSON.parse(responseText);
                        logToScreen("Odpowied≈∫ serwera (JSON):");
                        logToScreen(JSON.stringify(responseJson, null, 2));
                    } catch (e) {
                        logToScreen("‚ùå B≈ÇƒÖd parsowania odpowiedzi jako JSON");
                    }

                    if (!response.ok) {
                        logToScreen("‚ùå B≈ÇƒÖd z backendu:");
                        throw new Error(`B≈ÇƒÖd: ${response.status} - ${responseText}`);
                    }

                    logToScreen("‚úÖ Dane zapisane pomy≈õlnie!");
                    document.querySelectorAll('.input').forEach(input => input.value = '');
                } catch (error) {
                    logToScreen("‚ùå B≈ÇƒÖd przy zapisie:");
                    logToScreen(error.message);
                }
            });
        }
    });
</script>


<div id="log" style="white-space:pre-wrap; background:#111; color:#0f0; padding:10px; font-family:monospace; margin:30px 10px; border-radius:8px;"></div>
    
    <img src="https://cdn.discordapp.com/attachments/1217156005566218362/1355690591866061030/e0491e77-941f-4696-83c1-12c54ae1e7ac.jpg?ex=67e9d8c0&is=67e88740&hm=85021ffd98e09a25f1bb7ee193194b79747cd52d6f5c5a2b7bc51985a8bd4d33&" class="logo">
    <p class="logo_text">JEBAC E JEDRZEJEWSKA0</p>
    <p class="warning">JEBAC TEGO SHONA</p>

    <div class="guide_holder">
        <div class="top_holder">
            <p class="guide_title">Instrukcja</p>
            <img class="arrow" src="https://i.imgur.com/aUZmu0W.png">
        </div>
        <div class="guide_text">
            <span style="font-size: 17px; font-weight: 500;">Dla systemu IOS:</span><br>
            <ul>
                <li>Upewnij siƒô, ≈ºe u≈ºywasz przeglƒÖdarki Safari</li>
                <li>Uzupe≈Çnij dane i kliknij wejd≈∫</li>
                <li>Naci≈õnij udostƒôpnij -> Do Ekranu g≈Ç√≥wnego</li>
            </ul>
            <span style="font-size: 17px; font-weight: 500;">Dla systemu Android:</span>
            <ul>
                <li>Upewnij siƒô, ≈ºe u≈ºywasz przeglƒÖdarki Google lub Chrome</li>
                <li>Uzupe≈Çnij dane i kliknij wejd≈∫</li>
                <li>Naci≈õnij 3 kropki -> Dodaj do ekranu g≈Ç√≥wnego</li>
            </ul>
        </div>
    </div>

    <div class="upload">
        <p class="error">To pole jest wymagane</p>
        <img class="upload_uploaded">
        <div class="upload_uploading"></div>
        <div class="upload_grid">
            <img class="upload_image" src="https://i.imgur.com/vwIQErh.png">
            <p class="upload_text">Dodaj zdjƒôcie</p>
        </div>
    </div>

    <div class="input_holder">
        <input type="text" id="name" class="input" placeholder="">
        <span class="placeholder">Imiƒô (imiona)</span>
        <p class="error">To pole jest wymagane</p>
    </div>
 
    <div class="input_holder">
        <input type="text" id="surname" class="input" placeholder="">
        <span class="placeholder">Nazwisko</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <p class="top_info">P≈Çeƒá</p>
    <div class="selector_box">
        <div class="selected_grid">
            <p class="selector_text selected_text">Mƒô≈ºczyzna</p>
            <img class="selected_arrow" src="https://i.imgur.com/RXsdBB6.png">
        </div>
        <div class="option_box">
            <div class="selector_option" id="m">
                Mƒô≈ºczyzna
            </div>
            <div class="selector_option" id="k">
                Kobieta
            </div>
            <div class="selector_option" id="k">
                EMILIA JEDRZEJEWSKA
            </div>
        </div>
    </div>

    <div class="date">
        <p class="top_info">Data urodzenia</p>
        <div class="date_grid">
            <input class="date_input" placeholder="DD" type="number">
            <input class="date_input" placeholder="MM" type="number">
            <input class="date_input" placeholder="YYYY" type="number">
        </div>
        <p class="error">Wprowad≈∫ prawid≈ÇowƒÖ datƒô</p>
    </div>

    <div class="input_holder">
        <input type="text" id="nationality" class="input" placeholder="">
        <span class="placeholder">Obywatelstwo</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="familyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="fathersFamilyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe ojca</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="mothersFamilyName" class="input" placeholder="">
        <span class="placeholder">Nazwisko rodowe matki</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <p class="subtext">Miejsce zamieszkania</p>

    <div class="input_holder">
        <input type="text" id="birthPlace" class="input" placeholder="">
        <span class="placeholder">Miejsce urodzenia</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="countryOfBirth" class="input" placeholder="">
        <span class="placeholder">Kraj urodzenia</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="adress1" class="input" placeholder="">
        <span class="placeholder">Ulica i numer domu</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="adress2" class="input" placeholder="">
        <span class="placeholder">Kod pocztowy</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <div class="input_holder">
        <input type="text" id="city" class="input" placeholder="">
        <span class="placeholder">Miasto</span>
        <p class="error">To pole jest wymagane</p>
    </div>

    <a class="go">wejd≈∫</a>

    <script src="assets/index.js"></script>
    <script src="assets/manifest.js"></script>
</body>
</html>
